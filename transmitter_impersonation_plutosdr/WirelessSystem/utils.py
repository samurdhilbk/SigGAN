#from objects import *
import matplotlib.pyplot as plt
import matplotlib
import numpy as np
import datetime
import os
from scipy.signal import upfirdn
from numpy import sqrt
import collections

def store_configuration(file, **kwargs):

    config_file = file
    f = open(config_file, 'w')
    f.write('parameter\tvalue\n')
    for key in kwargs.keys():
        f.write('%s\t%s\n' % (key, str(kwargs[key])))
    f.close()

def make_session_dir(session_path):
	if not os.path.exists(session_path):
		os.mkdir(session_path)
	return session_path

mod_dict=collections.OrderedDict([
('bpsk', {'order': 2, 'constellation': np.array([1.00000000000000 + 0.00000000000000j,-1.00000000000000 + 1.22464679914735e-16j]).astype('complex64')}),
('qpsk', {'order': 4, 'constellation': np.array([0.70710678118 + 0.70710678118j,0.70710678118 - 0.70710678118j,-0.70710678118 - 0.70710678118j,-0.70710678118 + 0.70710678118j]).astype('complex64')}),
('psk8', {'order': 8, 'constellation': np.array([1.00000000000000 + 0.00000000000000j,0.707106781186548 + 0.707106781186548j,6.12323399573677e-17 + 1.00000000000000j,-0.707106781186548 + 0.707106781186548j,-1.00000000000000 + 1.22464679914735e-16j,-0.707106781186548 - 0.707106781186548j,-1.83697019872103e-16 - 1.00000000000000j,0.707106781186547 - 0.707106781186548j]).astype('complex64')}),
('psk16', {'order': 16, 'constellation': np.array([1.00000000000000 + 0.00000000000000j,0.923879532511287 + 0.382683432365090j,0.707106781186548 + 0.707106781186548j,0.382683432365090 + 0.923879532511287j,6.12323399573677e-17 + 1.00000000000000j,-0.382683432365090 + 0.923879532511287j,-0.707106781186548 + 0.707106781186548j,-0.923879532511287 + 0.382683432365090j,-1.00000000000000 + 1.22464679914735e-16j,-0.923879532511287 - 0.382683432365090j,-0.707106781186548 - 0.707106781186548j,-0.382683432365090 - 0.923879532511287j,-1.83697019872103e-16 - 1.00000000000000j,0.382683432365090 - 0.923879532511287j,0.707106781186547 - 0.707106781186548j,0.923879532511287 - 0.382683432365090j]).astype('complex64')}),
('qam16', {'order': 16, 'constellation': np.array([-0.948683298050514 + 0.948683298050514j,-0.948683298050514 + 0.316227766016838j,-0.948683298050514 - 0.316227766016838j,-0.948683298050514 - 0.948683298050514j,-0.316227766016838 + 0.948683298050514j,-0.316227766016838 + 0.316227766016838j,-0.316227766016838 - 0.316227766016838j,-0.316227766016838 - 0.948683298050514j,0.316227766016838 + 0.948683298050514j,0.316227766016838 + 0.316227766016838j,0.316227766016838 - 0.316227766016838j,0.316227766016838 - 0.948683298050514j,0.948683298050514 + 0.948683298050514j,0.948683298050514 + 0.316227766016838j,0.948683298050514 - 0.316227766016838j,0.948683298050514 - 0.948683298050514j]).astype('complex64')}),
('qam32', {'order': 32, 'constellation': np.array([-0.670820393249937 + 1.11803398874990j,-0.223606797749979 + 1.11803398874990j,-0.223606797749979 - 1.11803398874990j,-0.670820393249937 - 1.11803398874990j,-1.11803398874990 + 0.670820393249937j,-1.11803398874990 + 0.223606797749979j,-1.11803398874990 - 0.223606797749979j,-1.11803398874990 - 0.670820393249937j,-0.670820393249937 + 0.670820393249937j,-0.670820393249937 + 0.223606797749979j,-0.670820393249937 - 0.223606797749979j,-0.670820393249937 - 0.670820393249937j,-0.223606797749979 + 0.670820393249937j,-0.223606797749979 + 0.223606797749979j,-0.223606797749979 - 0.223606797749979j,-0.223606797749979 - 0.670820393249937j,0.223606797749979 + 0.670820393249937j,0.223606797749979 + 0.223606797749979j,0.223606797749979 - 0.223606797749979j,0.223606797749979 - 0.670820393249937j,0.670820393249937 + 0.670820393249937j,0.670820393249937 + 0.223606797749979j,0.670820393249937 - 0.223606797749979j,0.670820393249937 - 0.670820393249937j,1.11803398874990 + 0.670820393249937j,1.11803398874990 + 0.223606797749979j,1.11803398874990 - 0.223606797749979j,1.11803398874990 - 0.670820393249937j,0.670820393249937 + 1.11803398874990j,0.223606797749979 + 1.11803398874990j,0.223606797749979 - 1.11803398874990j,0.670820393249937 - 1.11803398874990j]).astype('complex64')}),
('qam64', {'order': 64, 'constellation': np.array([-1.08012344973464 + 1.08012344973464j,-1.08012344973464 + 0.771516749810460j,-1.08012344973464 + 0.462910049886276j,-1.08012344973464 + 0.154303349962092j,-1.08012344973464 - 0.154303349962092j,-1.08012344973464 - 0.462910049886276j,-1.08012344973464 - 0.771516749810460j,-1.08012344973464 - 1.08012344973464j,-0.771516749810460 + 1.08012344973464j,-0.771516749810460 + 0.771516749810460j,-0.771516749810460 + 0.462910049886276j,-0.771516749810460 + 0.154303349962092j,-0.771516749810460 - 0.154303349962092j,-0.771516749810460 - 0.462910049886276j,-0.771516749810460 - 0.771516749810460j,-0.771516749810460 - 1.08012344973464j,-0.462910049886276 + 1.08012344973464j,-0.462910049886276 + 0.771516749810460j,-0.462910049886276 + 0.462910049886276j,-0.462910049886276 + 0.154303349962092j,-0.462910049886276 - 0.154303349962092j,-0.462910049886276 - 0.462910049886276j,-0.462910049886276 - 0.771516749810460j,-0.462910049886276 - 1.08012344973464j,-0.154303349962092 + 1.08012344973464j,-0.154303349962092 + 0.771516749810460j,-0.154303349962092 + 0.462910049886276j,-0.154303349962092 + 0.154303349962092j,-0.154303349962092 - 0.154303349962092j,-0.154303349962092 - 0.462910049886276j,-0.154303349962092 - 0.771516749810460j,-0.154303349962092 - 1.08012344973464j,0.154303349962092 + 1.08012344973464j,0.154303349962092 + 0.771516749810460j,0.154303349962092 + 0.462910049886276j,0.154303349962092 + 0.154303349962092j,0.154303349962092 - 0.154303349962092j,0.154303349962092 - 0.462910049886276j,0.154303349962092 - 0.771516749810460j,0.154303349962092 - 1.08012344973464j,0.462910049886276 + 1.08012344973464j,0.462910049886276 + 0.771516749810460j,0.462910049886276 + 0.462910049886276j,0.462910049886276 + 0.154303349962092j,0.462910049886276 - 0.154303349962092j,0.462910049886276 - 0.462910049886276j,0.462910049886276 - 0.771516749810460j,0.462910049886276 - 1.08012344973464j,0.771516749810460 + 1.08012344973464j,0.771516749810460 + 0.771516749810460j,0.771516749810460 + 0.462910049886276j,0.771516749810460 + 0.154303349962092j,0.771516749810460 - 0.154303349962092j,0.771516749810460 - 0.462910049886276j,0.771516749810460 - 0.771516749810460j,0.771516749810460 - 1.08012344973464j,1.08012344973464 + 1.08012344973464j,1.08012344973464 + 0.771516749810460j,1.08012344973464 + 0.462910049886276j,1.08012344973464 + 0.154303349962092j,1.08012344973464 - 0.154303349962092j,1.08012344973464 - 0.462910049886276j,1.08012344973464 - 0.771516749810460j,1.08012344973464 - 1.08012344973464j]).astype('complex64')})
])

sps_filter={
    2: np.array([-0.0120059176147931,0.00863100036767819,0.0193478458508522,-0.0268274414065058,-0.0266838029991328,0.0600295880739653,0.0329462383413051,-0.130644555281419,-0.0371610308610786,0.443495229965941,0.745854302895469,0.443495229965941,-0.0371610308610786,-0.130644555281419,0.0329462383413051,0.0600295880739653,-0.0266838029991328,-0.0268274414065058,0.0193478458508522,0.00863100036767819,-0.0120059176147931]).astype('float32'),
    4: np.array([-0.00848977273295494,-0.00410375263794876,0.00610325957004339,0.0148423780873929,0.0136814876976658,-1.07218784092424e-17,-0.0189705516775549,-0.0291138954791167,-0.0188689803130457,0.0106324500165036,0.0424488636647747,0.0519808667473508,0.0232973509312447,-0.0360457753550969,-0.0923829913484155,-0.100017778681868,-0.0262777670691454,0.126160213742839,0.313609824035538,0.467827800726157,0.527417705721797,0.467827800726157,0.313609824035538,0.126160213742839,-0.0262777670691454,-0.100017778681868,-0.0923829913484155,-0.0360457753550969,0.0232973509312447,0.0519808667473508,0.0424488636647747,0.0106324500165036,-0.0188689803130457,-0.0291138954791167,-0.0189705516775549,-1.07218784092424e-17,0.0136814876976658,0.0148423780873929,0.00610325957004339,-0.00410375263794876,-0.00848977273295494]).astype('float32'),
    6: np.array([-0.00693195582506685,-0.00524570485974669,-0.000883737839314709,0.00498335197645883,0.0103424467655491,0.0129554467582638,0.0111710255768419,0.00466192618827419,-0.00519450599559476,-0.0154895814460969,-0.0225405192664819,-0.0230612412460635,-0.0154066477523436,-0.000473461010797235,0.0181060454403615,0.0346597791253342,0.0429784576216952,0.0382705608103099,0.0190224417751001,-0.0118271975278663,-0.0468549985484370,-0.0754313260387895,-0.0861098222854105,-0.0695846054499994,-0.0214559713474581,0.0559688113411811,0.153408337841203,0.256064504304426,0.346543365564822,0.408576177236956,0.430640059801587,0.408576177236956,0.346543365564822,0.256064504304426,0.153408337841203,0.0559688113411811,-0.0214559713474581,-0.0695846054499994,-0.0861098222854105,-0.0754313260387895,-0.0468549985484370,-0.0118271975278663,0.0190224417751001,0.0382705608103099,0.0429784576216952,0.0346597791253342,0.0181060454403615,-0.000473461010797235,-0.0154066477523436,-0.0230612412460635,-0.0225405192664819,-0.0154895814460969,-0.00519450599559476,0.00466192618827419,0.0111710255768419,0.0129554467582638,0.0103424467655491,0.00498335197645883,-0.000883737839314709,-0.00524570485974669,-0.00693195582506685]).astype('float32'),
    8: np.array([-0.00600328658761653,-0.00514422555493553,-0.00290184483674852,0.000441509630682432,0.00431573582357027,0.00794691919310520,0.0104953397579779,0.0112251595851443,0.00967445115170355,0.00579069704363893,-7.58165275713534e-18,-0.00681200565674492,-0.0134144531341197,-0.0184296736660069,-0.0205870126021875,-0.0189893694015900,-0.0133426300088814,-0.00409970012481894,0.00751841616793935,0.0196433058362273,0.0300164329380826,0.0363525585551739,0.0367567012654812,0.0301272943294763,0.0164740186541904,-0.00291328316518654,-0.0254886822693750,-0.0476827449282117,-0.0653258444402201,-0.0742117537736510,-0.0707245539039383,-0.0524363151329717,-0.0185815299844669,0.0296721661343255,0.0892103879428124,0.155232170394463,0.221759723092380,0.282335008199453,0.330810311389331,0.362123383225845,0.372947514430001,0.362123383225845,0.330810311389331,0.282335008199453,0.221759723092380,0.155232170394463,0.0892103879428124,0.0296721661343255,-0.0185815299844669,-0.0524363151329717,-0.0707245539039383,-0.0742117537736510,-0.0653258444402201,-0.0476827449282117,-0.0254886822693750,-0.00291328316518654,0.0164740186541904,0.0301272943294763,0.0367567012654812,0.0363525585551739,0.0300164329380826,0.0196433058362273,0.00751841616793935,-0.00409970012481894,-0.0133426300088814,-0.0189893694015900,-0.0205870126021875,-0.0184296736660069,-0.0134144531341197,-0.00681200565674492,-7.58165275713534e-18,0.00579069704363893,0.00967445115170355,0.0112251595851443,0.0104953397579779,0.00794691919310520,0.00431573582357027,0.000441509630682432,-0.00290184483674852,-0.00514422555493553,-0.00600328658761653]).astype('float32'),
    16: np.array([-0.00424500337913789,-0.00406738152921750,-0.00363754995618472,-0.00295969261986478,-0.00205193288008962,-0.000946274009627217,0.000312197301730512,0.00166684448517919,0.00305171390489887,0.00439439145528404,0.00561937171183110,0.00665179651674196,0.00742139361291184,0.00786642685249383,0.00793745886937882,0.00760072582669570,0.00684093241775274,0.00566329373769348,0.00409467849969339,0.00218374441385946,-5.36108698190064e-18,-0.00236822411171322,-0.00481685933355874,-0.00723015079029679,-0.00948553730569670,-0.0114591733639246,-0.0130318661031422,-0.0140951685421386,-0.0145573490099425,-0.0143489476008067,-0.0134276343634382,-0.0117821012352055,-0.00943475022350641,-0.00644298317386433,-0.00289895220381575,0.00107230747469794,0.00531637155295946,0.00965448402043416,0.0138900414689898,0.0178162975790346,0.0212250168956895,0.0239157520031202,0.0257053751565590,0.0264374666837756,0.0259911498144684,0.0242889661785996,0.0213034084524165,0.0170617661818551,0.0116489965678590,0.00520840210798627,-0.00206002107347542,-0.00990360972087891,-0.0180233844885002,-0.0260825782107549,-0.0337170998573288,-0.0405476052530181,-0.0461927689685509,-0.0502832893106445,-0.0524761130329401,-0.0524683405747181,-0.0500102678638630,-0.0449170376975488,-0.0370784122464125,-0.0264662372200218,-0.0131392457152260,0.00275505702757262,0.0209815812835552,0.0412219525770892,0.0630818457097506,0.0861011587480728,0.109766721654552,0.133527133358211,0.156809234432632,0.179035653809155,0.199642820039256,0.218098802651564,0.233920348330216,0.246688500206055,0.256062235747582,0.261789627850351,0.263716122142520,0.261789627850351,0.256062235747582,0.246688500206055,0.233920348330216,0.218098802651564,0.199642820039256,0.179035653809155,0.156809234432632,0.133527133358211,0.109766721654552,0.0861011587480728,0.0630818457097506,0.0412219525770892,0.0209815812835552,0.00275505702757262,-0.0131392457152260,-0.0264662372200218,-0.0370784122464125,-0.0449170376975488,-0.0500102678638630,-0.0524683405747181,-0.0524761130329401,-0.0502832893106445,-0.0461927689685509,-0.0405476052530181,-0.0337170998573288,-0.0260825782107549,-0.0180233844885002,-0.00990360972087891,-0.00206002107347542,0.00520840210798627,0.0116489965678590,0.0170617661818551,0.0213034084524165,0.0242889661785996,0.0259911498144684,0.0264374666837756,0.0257053751565590,0.0239157520031202,0.0212250168956895,0.0178162975790346,0.0138900414689898,0.00965448402043416,0.00531637155295946,0.00107230747469794,-0.00289895220381575,-0.00644298317386433,-0.00943475022350641,-0.0117821012352055,-0.0134276343634382,-0.0143489476008067,-0.0145573490099425,-0.0140951685421386,-0.0130318661031422,-0.0114591733639246,-0.00948553730569670,-0.00723015079029679,-0.00481685933355874,-0.00236822411171322,-5.36108698190064e-18,0.00218374441385946,0.00409467849969339,0.00566329373769348,0.00684093241775274,0.00760072582669570,0.00793745886937882,0.00786642685249383,0.00742139361291184,0.00665179651674196,0.00561937171183110,0.00439439145528404,0.00305171390489887,0.00166684448517919,0.000312197301730512,-0.000946274009627217,-0.00205193288008962,-0.00295969261986478,-0.00363754995618472,-0.00406738152921750,-0.00424500337913789]).astype('float32'),
    32: np.array([-0.00300168428320470,-0.00296098677208369,-0.00287608609925977,-0.00274645261996026,-0.00257214790134492,-0.00235384282329663,-0.00209282820923674,-0.00179101764458649,-0.00145094223166598,-0.00107573712633213,-0.000669119802415790,-0.000235360093854938,0.000220757829892166,0.000693981293314176,0.00117864238184067,0.00166871817556726,0.00215789737887853,0.00263965267981882,0.00310731808375002,0.00355417038377180,0.00397351385673433,0.00435876720954539,0.00470355174686222,0.00500177968905890,0.00524774153934297,0.00543619138170231,0.00556242898749012,0.00562237761824777,0.00561265643600897,0.00553064646984514,0.00537454913865674,0.00514343639487408,0.00483729163132119,0.00445704058336996,0.00400457155986021,0.00348274444812100,0.00289538805969147,0.00224728551276114,0.00154414748356436,0.000792573300496385,-3.79087814477372e-18,-0.000825360389340332,-0.00167459492027063,-0.00253817459722824,-0.00340604933956201,-0.00426775219509006,-0.00511251182957631,-0.00592937219410063,-0.00670731815861217,-0.00743540579773743,-0.00810289592560841,-0.00869938940140063,-0.00921496266760904,-0.00964030193986522,-0.00996683444116626,-0.0101868550654147,-0.0102936468656343,-0.0102815937914020,-0.0101462841479802,-0.00988460331619362,-0.00949481435690571,-0.00897662522641119,-0.00833124144839322,-0.00756140322327175,-0.00667140610559718,-0.00566710454322270,-0.00455589774674538,-0.00334669754241077,-0.00204987805444870,-0.000677207261646685,0.000758239324232858,0.00224218240601762,0.00375925941840730,0.00529316095737731,0.00682678206783277,0.00834238714669166,0.00982178703918856,0.0112465267385297,0.0125980819451661,0.0138580626038415,0.0150084214160235,0.0160316652239926,0.0169110670822048,0.0176308767728190,0.0181765274865326,0.0185348363778972,0.0186941967166475,0.0186447593935703,0.0183786016011023,0.0178898805949300,0.0171749705528855,0.0162325806805994,0.0150638528686626,0.0136724373821657,0.0120645452588989,0.0102489763054375,0.00823712180882859,0.00604294132346236,0.00368291314560218,0.00117595834945991,-0.00145666147398390,-0.00419147236373479,-0.00700294133857504,-0.00986365399895649,-0.0127445151669758,-0.0156149710954637,-0.0184432515331897,-0.0211966297027630,-0.0238416980335929,-0.0263446572966946,-0.0286716166134809,-0.0307889016590367,-0.0326633682536112,-0.0342627184358049,-0.0355558160385373,-0.0365129987454548,-0.0371063835917697,-0.0373101628901043,-0.0371008876089393,-0.0364577353086027,-0.0353627598469193,-0.0338011202029369,-0.0317612859314677,-0.0292352169521273,-0.0262185155925233,-0.0227105490442444,-0.0187145406501515,-0.0142376287197730,-0.00929089186368759,-0.00388934014483146,0.00194812833828106,0.00819880549749483,0.0148362856635511,0.0218306117626023,0.0291484543408743,0.0367533221985704,0.0446058030844152,0.0526638326050709,0.0608829892220935,0.0692168129460349,0.0776171450954854,0.0860344862708335,0.0944183695005960,0.102717745354416,0.110881375683000,0.118858232542869,0.126597898793984,0.134050966821947,0.141169431834045,0.147907076210089,0.154219841454618,0.160066184396049,0.165407414409921,0.170208008606249,0.174435902113754,0.178062750814412,0.181064164128385,0.183419905719487,0.185114060282325,0.186135164881305,0.186476303635748,0.186135164881305,0.185114060282325,0.183419905719487,0.181064164128385,0.178062750814412,0.174435902113754,0.170208008606249,0.165407414409921,0.160066184396049,0.154219841454618,0.147907076210089,0.141169431834045,0.134050966821947,0.126597898793984,0.118858232542869,0.110881375683000,0.102717745354416,0.0944183695005960,0.0860344862708335,0.0776171450954854,0.0692168129460349,0.0608829892220935,0.0526638326050709,0.0446058030844152,0.0367533221985704,0.0291484543408743,0.0218306117626023,0.0148362856635511,0.00819880549749483,0.00194812833828106,-0.00388934014483146,-0.00929089186368759,-0.0142376287197730,-0.0187145406501515,-0.0227105490442444,-0.0262185155925233,-0.0292352169521273,-0.0317612859314677,-0.0338011202029369,-0.0353627598469193,-0.0364577353086027,-0.0371008876089393,-0.0373101628901043,-0.0371063835917697,-0.0365129987454548,-0.0355558160385373,-0.0342627184358049,-0.0326633682536112,-0.0307889016590367,-0.0286716166134809,-0.0263446572966946,-0.0238416980335929,-0.0211966297027630,-0.0184432515331897,-0.0156149710954637,-0.0127445151669758,-0.00986365399895649,-0.00700294133857504,-0.00419147236373479,-0.00145666147398390,0.00117595834945991,0.00368291314560218,0.00604294132346236,0.00823712180882859,0.0102489763054375,0.0120645452588989,0.0136724373821657,0.0150638528686626,0.0162325806805994,0.0171749705528855,0.0178898805949300,0.0183786016011023,0.0186447593935703,0.0186941967166475,0.0185348363778972,0.0181765274865326,0.0176308767728190,0.0169110670822048,0.0160316652239926,0.0150084214160235,0.0138580626038415,0.0125980819451661,0.0112465267385297,0.00982178703918856,0.00834238714669166,0.00682678206783277,0.00529316095737731,0.00375925941840730,0.00224218240601762,0.000758239324232858,-0.000677207261646685,-0.00204987805444870,-0.00334669754241077,-0.00455589774674538,-0.00566710454322270,-0.00667140610559718,-0.00756140322327175,-0.00833124144839322,-0.00897662522641119,-0.00949481435690571,-0.00988460331619362,-0.0101462841479802,-0.0102815937914020,-0.0102936468656343,-0.0101868550654147,-0.00996683444116626,-0.00964030193986522,-0.00921496266760904,-0.00869938940140063,-0.00810289592560841,-0.00743540579773743,-0.00670731815861217,-0.00592937219410063,-0.00511251182957631,-0.00426775219509006,-0.00340604933956201,-0.00253817459722824,-0.00167459492027063,-0.000825360389340332,-3.79087814477372e-18,0.000792573300496385,0.00154414748356436,0.00224728551276114,0.00289538805969147,0.00348274444812100,0.00400457155986021,0.00445704058336996,0.00483729163132119,0.00514343639487408,0.00537454913865674,0.00553064646984514,0.00561265643600897,0.00562237761824777,0.00556242898749012,0.00543619138170231,0.00524774153934297,0.00500177968905890,0.00470355174686222,0.00435876720954539,0.00397351385673433,0.00355417038377180,0.00310731808375002,0.00263965267981882,0.00215789737887853,0.00166871817556726,0.00117864238184067,0.000693981293314176,0.000220757829892166,-0.000235360093854938,-0.000669119802415790,-0.00107573712633213,-0.00145094223166598,-0.00179101764458649,-0.00209282820923674,-0.00235384282329663,-0.00257214790134492,-0.00274645261996026,-0.00287608609925977,-0.00296098677208369,-0.00300168428320470]).astype('float32')
    }


def generate_symbols(n_symbols, sample_rate):
    fs = int(sample_rate)
    fc = 3000000
    N = n_symbols #1024
    ts = 1 / float(fs)
    t = np.arange(0, N * ts, ts)
    i = np.cos(2 * np.pi * t * fc) * 2 ** 14
    q = np.sin(2 * np.pi * t * fc) * 2 ** 14
    iq = i + 1j * q
    return iq

# def generate_symbols(n_symbols,oversamp=2,mod='qpsk', same_pkt = 0):

#     #sps=2 # need to regenerate filter to change it
#     sps=oversamp 
#     h=sps_filter[int(sps)]
#     skp=int(np.floor(h.size)/2)

#     n_symbols=int((n_symbols)) #/sps
#     # rcosdesign(0.2,10,2)
    
#     order=mod_dict[mod]['order']
#     const=mod_dict[mod]['constellation']

#     if same_pkt == 0:
#         symbs=np.random.randint(0,order,n_symbols)
#     elif same_pkt == 1:
#         st = np.random.get_state()
#         np.random.seed(5)
#         # Omitted for speed
#         #itr = (np.random.randint(0,order) for x in range(n_symbols))
#         #symbs = np.fromiter(itr,dtype='int', count = n_symbols)
#         symbs=np.random.randint(0,order,n_symbols)
#         np.random.set_state(st)

#     s=const[symbs]
    
#     mod=upfirdn(h, s,sps).astype('complex64')

#     return mod[skp:-skp].astype('complex64')


def generate_rf_fingerprints(n,coef_set=0,scale = 1):
    
    if coef_set==0:
        a_b=[0.2,0.15];
        # uniform around a_b 
        a=np.array(
        [ [0.215239370772373,0.0154401609902490],
            [0.262444346785431,0.132242953095191],
            [0.137271421673883,0.00896286326357010],
            [0.203248281559299,0.137049967318413],
            [0.317884086304296,0.194743214284428],
            [0.318887926680031,0.0835461847943926],
            [0.0876755931391509,0.202876470594039],
            [0.112172863441456,0.177258845224905]])
    elif coef_set==1:
        # USRP curves for hos/usrp_nonlinearity_estimation
        a=np.array( [[ -0.615932266666845  ,  0.179472076994283],
           [ -0.0919283563256818 , -0.0498965361328448],
           [ -0.179405352436900  , -0.0659844065280134],
           [ -0.150908888098051  , -0.0851037648651595]])
    elif coef_set==2:
        st=np.random.get_state()
        np.random.seed(0)
        a_b = np.array([-0.259543715881870,-0.00537815763293363])
        a_s = np.array([0.240368738256471,0.124070927456406])
        a_s = a_s*scale

        for i in range(n):
            ac = a_b+np.random.randn(2,)*a_s
            r=np.roots([5*ac[1], 3*ac[0], 1]);
            while( (np.any( np.less(r[np.where(r>0)], 1)))  or ((1+3*ac[0]*0.5**2 + 5*ac[1]*0.5**4) <0)  or (1.0+ac[0]+ac[1]>1)):
                ac = a_b+np.random.randn(2,)*a_s
                r=np.roots([5*ac[1], 3*ac[0], 1]) 
            
            if i==0:
                a=ac
                #print(a)
            else:
                #print(a_b+np.random.randn(1,2)*a_s)
                a=np.vstack((a,ac))
        np.random.set_state(st)
    elif coef_set==3:
        kB=19.495587753608426
        thetaB = 0.082575343055871
        k=kB/scale
        theta=thetaB*scale
        l1 = -0.947486246365197
        l2 = 0.994116685079171
        st=np.random.get_state()
        np.random.seed(0)
        for i in range(n):
            c1=np.random.gamma(k,theta)
            while(c1<1 or c1>3):
                c1=np.random.gamma(k,theta)
            c2 = l1 + l2 * c1
            ac = np.array([c1,c2])
            if i==0:
                a = ac
            else:
               a = np.vstack((a,ac)) 

        np.random.set_state(st)


    else:
        raise ValueError("Given coef_set {} is not valid.".format(coef_set))
   
    if a.shape[0]<n:
        raise ValueError('Not Enough rf_fingerprints. Asked for {} only {} availables for coef_set {}'
            .format(n,a.shape[0],coef_set))
    return a[0:n]

def add_noise(x,snr):
    shp=np.shape(x)
    ratio = np.power(10,snr/10,dtype='float32')
    #print(shp)
    y = x + 1/ratio / sqrt(2,dtype='float32') * (np.random.standard_normal(shp)  + 1j*np.random.standard_normal(shp))
    return y.astype('complex64')

def normalize(x):
    x=x/(np.sqrt(np.mean(np.abs(x)**2)))
    return x.astype('complex64')

def add_non_linearity(x,a=[0.2,0.15],method = 0):
    # 0 Voterra Series
    # 1 Saleh model
    if method==0:
        y=x*(1+ a[0]*np.abs(x)**2 + a[1]*np.abs(x)**4 )
    else:
        mg = np.abs(x)
        ph = np.angle(x)

        mgo = a[0] * mg /(1 + a[1] * mg**2)
        y=mgo*np.exp(1j*ph)

    return y.astype('complex64')

def simulate_fading_channel(x):
    samp_rate = 1e6
    delay_spread = 26 # samples

    #n_paths = np.random.randint(1,20)
    coeff=np.zeros(delay_spread)
    coeff[0] =  0.71429  
    coeff[20] = 0.46429
    coeff[25] = 0.26786
    # for i in range(n_paths):
    #     idx = np.random.randint(0,delay_spread)
    #     mag = np.random.randn()
    #     coeff[idx]=mag
    n = np.sqrt(np.sum(np.square(coeff)))
    #print(coeff)
    ray = np.random.rayleigh(scale=0.5)
    #print(ray)
    coeff=coeff/n*ray
    y = np.convolve(x,coeff,mode='same')
    return y
#@profile
def simulate_timing_error(x):
    lp32=np.array([-0.00769647194304594,0.00321121871353699,0.00262724642768595,0.00215974524025664,0.00178650854729232,0.00148709945292228,0.00124772169963748,0.00105465234274052,0.000899501427052986,0.000772880373942138,0.000669954245673063,0.000584122669198574,0.000512894128719519,0.000451459098838088,0.000398831953153266,0.000351405434691855,0.000309206016716929,0.000269383912357743,0.000232678507649252,0.000196697526863559,0.000162663115026186,0.000128498062176727,9.57910865964598e-05,6.26088214163090e-05,3.08113850095087e-05,-1.48897874568125e-06,-3.21909522373386e-05,-6.31957913634798e-05,-9.21785596300005e-05,-0.000121170189044627,-0.000147618507825824,-0.000173755758239953,-0.000196776421788013,-0.000219166214894358,-0.000237788954240409,-0.000255594418813250,-0.000268977600030654,-0.000281536631309325,-0.000288959475638224,-0.000295836250800890,-0.000296591124317143,-0.000297863184859936,-0.000290997095865352,-0.000287304059827976,-0.000274064274490736,-0.000259143532927897,-0.000250422640345842,-0.000221602967089856,-0.000202499040375575,-0.000180938657960961,-0.000154865504964671,-0.000122029364524909,-9.17186495217844e-05,-6.14514259141400e-05,-3.12337369022983e-05,3.04384683681344e-06,3.81854085752651e-05,7.36782806149430e-05,0.000106458867602127,0.000138109591679169,0.000168233874890026,0.000198551039285957,0.000227586390421152,0.000255218996185808,0.000279489034830375,0.000300572153802836,0.000317748362212526,0.000332001947369007,0.000343058610725673,0.000351440966112973,0.000356381241009475,0.000357815823598300,0.000354969482070707,0.000347950161530093,0.000336587625174900,0.000321366918899600,0.000302568741553450,0.000280648367021649,0.000255840158065982,0.000228249566023826,0.000198076383851371,0.000165170574794030,0.000130071536789590,9.26021809328568e-05,5.38640322810326e-05,1.34308662668156e-05,-2.66736132739590e-05,-6.83006739466284e-05,-0.000107066213134282,-0.000148026591742578,-0.000184820364343497,-0.000221012703278214,-0.000257161924989897,-0.000287893834999609,-0.000317833702950876,-0.000345480766591456,-0.000369232405832224,-0.000388112795898456,-0.000404382648264335,-0.000416598566183698,-0.000424078620876133,-0.000425930771649939,-0.000423760618335454,-0.000417348224036100,-0.000406740566447956,-0.000390922434463672,-0.000370732509988182,-0.000346427174412999,-0.000318937871354803,-0.000287756117200505,-0.000253112808319447,-0.000214779942030268,-0.000173772011770183,-0.000130414610514868,-8.55617179994916e-05,-3.90992775594293e-05,8.38560142081491e-06,5.67991861239686e-05,0.000105079882550523,0.000152789784941345,0.000198930913984065,0.000243390252715503,0.000285526788894647,0.000325370650330167,0.000362102250948514,0.000395574380635108,0.000424898245270208,0.000450043711768728,0.000470372685495538,0.000486155253080375,0.000496864240527779,0.000502680799181723,0.000503474855201309,0.000498256231921691,0.000488881509024593,0.000472262951047335,0.000451859642381429,0.000425752210179163,0.000394312382295922,0.000359165416607813,0.000319767614734721,0.000275810746632100,0.000228702139742104,0.000178928678710458,0.000126233359061747,7.13271477627389e-05,1.54227185952199e-05,-4.08765319602211e-05,-9.75210323704749e-05,-0.000153898570074822,-0.000209051910619015,-0.000262271516105892,-0.000313400029730188,-0.000362039926908237,-0.000407490736145986,-0.000448880214652848,-0.000485756803957658,-0.000517842550807179,-0.000544945961527342,-0.000566554266453364,-0.000582263574404699,-0.000591780881061798,-0.000595195853877133,-0.000592437596123702,-0.000583519791486970,-0.000568165306661166,-0.000546443457751408,-0.000518408072433137,-0.000484575076028597,-0.000445127510802836,-0.000400667144928898,-0.000351233476609760,-0.000297568015245019,-0.000239856315846643,-0.000179275346011913,-0.000115859777354642,-5.10165281869553e-05,1.55028040690070e-05,8.24963958696085e-05,0.000149238365486922,0.000215846040346105,0.000279846427046173,0.000342250853532837,0.000401322973006095,0.000456504246929727,0.000507563776743879,0.000554047299155200,0.000594584378142095,0.000629399119734177,0.000657957502168946,0.000679730335013698,0.000694196748476186,0.000701726614833847,0.000701968830235404,0.000694692294892683,0.000679662930221701,0.000657347114005477,0.000627733265388122,0.000591004821939059,0.000547331388025441,0.000497500843463857,0.000441931518152605,0.000381152507729778,0.000315456216853518,0.000245667043315630,0.000172473936248222,9.68054120945766e-05,1.91847195644333e-05,-5.95319624032041e-05,-0.000138571217938357,-0.000216865318897236,-0.000293696587426215,-0.000368200418816565,-0.000439765202818956,-0.000507460132071702,-0.000570452311694623,-0.000627927610267225,-0.000679230320403065,-0.000723856666136036,-0.000761165003632527,-0.000790946574789852,-0.000812232174549349,-0.000825460992507382,-0.000829576571109522,-0.000825244991358554,-0.000812117234488977,-0.000789812582798052,-0.000759226176281503,-0.000719753406755943,-0.000672149981037632,-0.000617000964924832,-0.000554707309647762,-0.000485531751599831,-0.000410683031109601,-0.000330439534739181,-0.000245667556465734,-0.000157258972283059,-6.64541065661487e-05,2.62377361038832e-05,0.000119690236797387,0.000212939725495590,0.000304755078900022,0.000394494181030350,0.000480969190124965,0.000563255817079495,0.000640247637134904,0.000711442166606321,0.000775864281703970,0.000832827330160226,0.000881378220154815,0.000921154764862417,0.000951442707822524,0.000971978065002903,0.000982143351386952,0.000981964884430822,0.000971221814872353,0.000950170501325641,0.000918567861715192,0.000876835041018261,0.000825040329474925,0.000763985155612283,0.000693998161385272,0.000615937303371330,0.000530200399995211,0.000437897694916826,0.000339786003810977,0.000236890221264991,0.000130466363305417,2.10666612285051e-05,-8.94877525371380e-05,-0.000200607893984625,-0.000310788547266251,-0.000418712473241415,-0.000523670349138412,-0.000624232954392420,-0.000719292544670840,-0.000807892549242551,-0.000888905418133759,-0.000961124804039959,-0.00102407669573969,-0.00107680035540865,-0.00111858699651523,-0.00114878112512137,-0.00116717111156634,-0.00117316894132457,-0.00116670746853704,-0.00114768279668499,-0.00111632227130392,-0.00107249822696909,-0.00101664538111835,-0.000949188051554660,-0.000870916070266027,-0.000782283167447406,-0.000684251377441041,-0.000577661702992352,-0.000463692310800587,-0.000343215473941293,-0.000217628901154434,-8.80930711915416e-05,4.38197131408679e-05,0.000176943054538336,0.000309741470429823,0.000441019558572935,0.000569046872645978,0.000692713843474405,0.000810385609132644,0.000921061376389984,0.00102310711514180,0.00111566469714633,0.00119717971621020,0.00126719307875044,0.00132435144696304,0.00136812417042884,0.00139776654215982,0.00141259508195676,0.00141271303683093,0.00139761832574357,0.00136738562952608,0.00132224812273576,0.00126222024488979,0.00118787871150576,0.00109994389917251,0.000999044836218414,0.000886062505035234,0.000762231940616375,0.000628513758930724,0.000486302180420715,0.000337021018370648,0.000182214643727395,2.32210983786354e-05,-0.000138149156234767,-0.000300237874602826,-0.000461234922698014,-0.000619572158516572,-0.000773356777026351,-0.000921000608283331,-0.00106079820792786,-0.00119127335434101,-0.00131067808130358,-0.00141768844853713,-0.00151098945760487,-0.00158953542355271,-0.00165209134191896,-0.00169788215011939,-0.00172608159890321,-0.00173625528171266,-0.00172792202592371,-0.00170099859065911,-0.00165536583608036,-0.00159143712576914,-0.00150939247417829,-0.00141002671768831,-0.00129395646257226,-0.00116248993008418,-0.00101646422220953,-0.000857673856153692,-0.000686997373966146,-0.000506656541647397,-0.000317988335514920,-0.000123137592397491,7.59745120693218e-05,0.000277404352022103,0.000478925171769185,0.000678290216671388,0.000873595896567303,0.00106251408690811,0.00124302349658705,0.00141309967772464,0.00157070131347568,0.00171385408329971,0.00184102933569760,0.00195048809626378,0.00204083693255018,0.00211074602279177,0.00215921960739903,0.00218520829759615,0.00218822980994522,0.00216782852875287,0.00212391823588935,0.00205638105379965,0.00196567922731192,0.00185231752206465,0.00171721242340603,0.00156127282907593,0.00138595154329942,0.00119268760586775,0.000983253581540644,0.000759493029653537,0.000523695320254755,0.000278008651587528,2.48819616455120e-05,-0.000233181216090764,-0.000493449412348558,-0.000753204024826017,-0.00100960659794921,-0.00126000073707779,-0.00150153635631209,-0.00173154018710445,-0.00194730055429845,-0.00214637243583583,-0.00232609109603919,-0.00248456659360856,-0.00261919055016711,-0.00272864126855518,-0.00281077128077487,-0.00286447215902727,-0.00288840626750580,-0.00288180486995755,-0.00284403298610570,-0.00277508381113763,-0.00267469700422221,-0.00254349287707399,-0.00238211579876952,-0.00219167787133137,-0.00197347727854318,-0.00172937580425457,-0.00146117028888270,-0.00117131651613072,-0.000862306103073437,-0.000537050203317532,-0.000198432739574632,0.000150113961679946,0.000505276266859358,0.000863337387832592,0.00122072300984398,0.00157349289222906,0.00191801095072164,0.00225036446884379,0.00256687962977540,0.00286360741033633,0.00313708163392386,0.00338376670622440,0.00360048060317803,0.00378402070355054,0.00393176940724828,0.00404106739620652,0.00410978911510815,0.00413608672178751,0.00411856710411932,0.00405612478850470,0.00394816090858909,0.00379440567940195,0.00359513860403345,0.00335115092627061,0.00306351912827011,0.00273392967245937,0.00236457253676703,0.00195780758993177,0.00151705326670102,0.00104532840797343,0.000546871616717864,2.56122675871940e-05,-0.000513655326860101,-0.00106615951778255,-0.00162647453038200,-0.00218943710435720,-0.00274904783807734,-0.00329973411443714,-0.00383544388593115,-0.00435026608568188,-0.00483795763145401,-0.00529272362524361,-0.00570845210237807,-0.00607953428421639,-0.00640023424410617,-0.00666532441805131,-0.00686954163664438,-0.00700833610692935,-0.00707720275901424,-0.00707235769831703,-0.00699014778034679,-0.00682778024208396,-0.00658266170958748,-0.00625308256596255,-0.00583758343284242,-0.00533573059607256,-0.00474732216073382,-0.00407309041332139,-0.00331418459207658,-0.00247277573162850,-0.00155117405293334,-0.000552737861898644,0.000518834016709434,0.00165902386398939,0.00286289601564509,0.00412473576440186,0.00543859514102882,0.00679783952789866,0.00819550335036157,0.00962429660308144,0.0110762864444002,0.0125436089792591,0.0140179816140879,0.0154909221162772,0.0169541342494615,0.0183987677172699,0.0198165138126304,0.0211986899472309,0.0225371150549745,0.0238234895959293,0.0250501275029083,0.0262091371299521,0.0272936171978461,0.0282965971474610,0.0292119147754275,0.0300336421684714,0.0307568027543635,0.0313765757535467,0.0318892105800805,0.0322912940256883,0.0325804449534184,0.0327546263944335,0.0328128745371927,0.0327546263944335,0.0325804449534184,0.0322912940256883,0.0318892105800805,0.0313765757535467,0.0307568027543635,0.0300336421684714,0.0292119147754275,0.0282965971474610,0.0272936171978461,0.0262091371299521,0.0250501275029083,0.0238234895959293,0.0225371150549745,0.0211986899472309,0.0198165138126304,0.0183987677172699,0.0169541342494615,0.0154909221162772,0.0140179816140879,0.0125436089792591,0.0110762864444002,0.00962429660308144,0.00819550335036157,0.00679783952789866,0.00543859514102882,0.00412473576440186,0.00286289601564509,0.00165902386398939,0.000518834016709434,-0.000552737861898644,-0.00155117405293334,-0.00247277573162850,-0.00331418459207658,-0.00407309041332139,-0.00474732216073382,-0.00533573059607256,-0.00583758343284242,-0.00625308256596255,-0.00658266170958748,-0.00682778024208396,-0.00699014778034679,-0.00707235769831703,-0.00707720275901424,-0.00700833610692935,-0.00686954163664438,-0.00666532441805131,-0.00640023424410617,-0.00607953428421639,-0.00570845210237807,-0.00529272362524361,-0.00483795763145401,-0.00435026608568188,-0.00383544388593115,-0.00329973411443714,-0.00274904783807734,-0.00218943710435720,-0.00162647453038200,-0.00106615951778255,-0.000513655326860101,2.56122675871940e-05,0.000546871616717864,0.00104532840797343,0.00151705326670102,0.00195780758993177,0.00236457253676703,0.00273392967245937,0.00306351912827011,0.00335115092627061,0.00359513860403345,0.00379440567940195,0.00394816090858909,0.00405612478850470,0.00411856710411932,0.00413608672178751,0.00410978911510815,0.00404106739620652,0.00393176940724828,0.00378402070355054,0.00360048060317803,0.00338376670622440,0.00313708163392386,0.00286360741033633,0.00256687962977540,0.00225036446884379,0.00191801095072164,0.00157349289222906,0.00122072300984398,0.000863337387832592,0.000505276266859358,0.000150113961679946,-0.000198432739574632,-0.000537050203317532,-0.000862306103073437,-0.00117131651613072,-0.00146117028888270,-0.00172937580425457,-0.00197347727854318,-0.00219167787133137,-0.00238211579876952,-0.00254349287707399,-0.00267469700422221,-0.00277508381113763,-0.00284403298610570,-0.00288180486995755,-0.00288840626750580,-0.00286447215902727,-0.00281077128077487,-0.00272864126855518,-0.00261919055016711,-0.00248456659360856,-0.00232609109603919,-0.00214637243583583,-0.00194730055429845,-0.00173154018710445,-0.00150153635631209,-0.00126000073707779,-0.00100960659794921,-0.000753204024826017,-0.000493449412348558,-0.000233181216090764,2.48819616455120e-05,0.000278008651587528,0.000523695320254755,0.000759493029653537,0.000983253581540644,0.00119268760586775,0.00138595154329942,0.00156127282907593,0.00171721242340603,0.00185231752206465,0.00196567922731192,0.00205638105379965,0.00212391823588935,0.00216782852875287,0.00218822980994522,0.00218520829759615,0.00215921960739903,0.00211074602279177,0.00204083693255018,0.00195048809626378,0.00184102933569760,0.00171385408329971,0.00157070131347568,0.00141309967772464,0.00124302349658705,0.00106251408690811,0.000873595896567303,0.000678290216671388,0.000478925171769185,0.000277404352022103,7.59745120693218e-05,-0.000123137592397491,-0.000317988335514920,-0.000506656541647397,-0.000686997373966146,-0.000857673856153692,-0.00101646422220953,-0.00116248993008418,-0.00129395646257226,-0.00141002671768831,-0.00150939247417829,-0.00159143712576914,-0.00165536583608036,-0.00170099859065911,-0.00172792202592371,-0.00173625528171266,-0.00172608159890321,-0.00169788215011939,-0.00165209134191896,-0.00158953542355271,-0.00151098945760487,-0.00141768844853713,-0.00131067808130358,-0.00119127335434101,-0.00106079820792786,-0.000921000608283331,-0.000773356777026351,-0.000619572158516572,-0.000461234922698014,-0.000300237874602826,-0.000138149156234767,2.32210983786354e-05,0.000182214643727395,0.000337021018370648,0.000486302180420715,0.000628513758930724,0.000762231940616375,0.000886062505035234,0.000999044836218414,0.00109994389917251,0.00118787871150576,0.00126222024488979,0.00132224812273576,0.00136738562952608,0.00139761832574357,0.00141271303683093,0.00141259508195676,0.00139776654215982,0.00136812417042884,0.00132435144696304,0.00126719307875044,0.00119717971621020,0.00111566469714633,0.00102310711514180,0.000921061376389984,0.000810385609132644,0.000692713843474405,0.000569046872645978,0.000441019558572935,0.000309741470429823,0.000176943054538336,4.38197131408679e-05,-8.80930711915416e-05,-0.000217628901154434,-0.000343215473941293,-0.000463692310800587,-0.000577661702992352,-0.000684251377441041,-0.000782283167447406,-0.000870916070266027,-0.000949188051554660,-0.00101664538111835,-0.00107249822696909,-0.00111632227130392,-0.00114768279668499,-0.00116670746853704,-0.00117316894132457,-0.00116717111156634,-0.00114878112512137,-0.00111858699651523,-0.00107680035540865,-0.00102407669573969,-0.000961124804039959,-0.000888905418133759,-0.000807892549242551,-0.000719292544670840,-0.000624232954392420,-0.000523670349138412,-0.000418712473241415,-0.000310788547266251,-0.000200607893984625,-8.94877525371380e-05,2.10666612285051e-05,0.000130466363305417,0.000236890221264991,0.000339786003810977,0.000437897694916826,0.000530200399995211,0.000615937303371330,0.000693998161385272,0.000763985155612283,0.000825040329474925,0.000876835041018261,0.000918567861715192,0.000950170501325641,0.000971221814872353,0.000981964884430822,0.000982143351386952,0.000971978065002903,0.000951442707822524,0.000921154764862417,0.000881378220154815,0.000832827330160226,0.000775864281703970,0.000711442166606321,0.000640247637134904,0.000563255817079495,0.000480969190124965,0.000394494181030350,0.000304755078900022,0.000212939725495590,0.000119690236797387,2.62377361038832e-05,-6.64541065661487e-05,-0.000157258972283059,-0.000245667556465734,-0.000330439534739181,-0.000410683031109601,-0.000485531751599831,-0.000554707309647762,-0.000617000964924832,-0.000672149981037632,-0.000719753406755943,-0.000759226176281503,-0.000789812582798052,-0.000812117234488977,-0.000825244991358554,-0.000829576571109522,-0.000825460992507382,-0.000812232174549349,-0.000790946574789852,-0.000761165003632527,-0.000723856666136036,-0.000679230320403065,-0.000627927610267225,-0.000570452311694623,-0.000507460132071702,-0.000439765202818956,-0.000368200418816565,-0.000293696587426215,-0.000216865318897236,-0.000138571217938357,-5.95319624032041e-05,1.91847195644333e-05,9.68054120945766e-05,0.000172473936248222,0.000245667043315630,0.000315456216853518,0.000381152507729778,0.000441931518152605,0.000497500843463857,0.000547331388025441,0.000591004821939059,0.000627733265388122,0.000657347114005477,0.000679662930221701,0.000694692294892683,0.000701968830235404,0.000701726614833847,0.000694196748476186,0.000679730335013698,0.000657957502168946,0.000629399119734177,0.000594584378142095,0.000554047299155200,0.000507563776743879,0.000456504246929727,0.000401322973006095,0.000342250853532837,0.000279846427046173,0.000215846040346105,0.000149238365486922,8.24963958696085e-05,1.55028040690070e-05,-5.10165281869553e-05,-0.000115859777354642,-0.000179275346011913,-0.000239856315846643,-0.000297568015245019,-0.000351233476609760,-0.000400667144928898,-0.000445127510802836,-0.000484575076028597,-0.000518408072433137,-0.000546443457751408,-0.000568165306661166,-0.000583519791486970,-0.000592437596123702,-0.000595195853877133,-0.000591780881061798,-0.000582263574404699,-0.000566554266453364,-0.000544945961527342,-0.000517842550807179,-0.000485756803957658,-0.000448880214652848,-0.000407490736145986,-0.000362039926908237,-0.000313400029730188,-0.000262271516105892,-0.000209051910619015,-0.000153898570074822,-9.75210323704749e-05,-4.08765319602211e-05,1.54227185952199e-05,7.13271477627389e-05,0.000126233359061747,0.000178928678710458,0.000228702139742104,0.000275810746632100,0.000319767614734721,0.000359165416607813,0.000394312382295922,0.000425752210179163,0.000451859642381429,0.000472262951047335,0.000488881509024593,0.000498256231921691,0.000503474855201309,0.000502680799181723,0.000496864240527779,0.000486155253080375,0.000470372685495538,0.000450043711768728,0.000424898245270208,0.000395574380635108,0.000362102250948514,0.000325370650330167,0.000285526788894647,0.000243390252715503,0.000198930913984065,0.000152789784941345,0.000105079882550523,5.67991861239686e-05,8.38560142081491e-06,-3.90992775594293e-05,-8.55617179994916e-05,-0.000130414610514868,-0.000173772011770183,-0.000214779942030268,-0.000253112808319447,-0.000287756117200505,-0.000318937871354803,-0.000346427174412999,-0.000370732509988182,-0.000390922434463672,-0.000406740566447956,-0.000417348224036100,-0.000423760618335454,-0.000425930771649939,-0.000424078620876133,-0.000416598566183698,-0.000404382648264335,-0.000388112795898456,-0.000369232405832224,-0.000345480766591456,-0.000317833702950876,-0.000287893834999609,-0.000257161924989897,-0.000221012703278214,-0.000184820364343497,-0.000148026591742578,-0.000107066213134282,-6.83006739466284e-05,-2.66736132739590e-05,1.34308662668156e-05,5.38640322810326e-05,9.26021809328568e-05,0.000130071536789590,0.000165170574794030,0.000198076383851371,0.000228249566023826,0.000255840158065982,0.000280648367021649,0.000302568741553450,0.000321366918899600,0.000336587625174900,0.000347950161530093,0.000354969482070707,0.000357815823598300,0.000356381241009475,0.000351440966112973,0.000343058610725673,0.000332001947369007,0.000317748362212526,0.000300572153802836,0.000279489034830375,0.000255218996185808,0.000227586390421152,0.000198551039285957,0.000168233874890026,0.000138109591679169,0.000106458867602127,7.36782806149430e-05,3.81854085752651e-05,3.04384683681344e-06,-3.12337369022983e-05,-6.14514259141400e-05,-9.17186495217844e-05,-0.000122029364524909,-0.000154865504964671,-0.000180938657960961,-0.000202499040375575,-0.000221602967089856,-0.000250422640345842,-0.000259143532927897,-0.000274064274490736,-0.000287304059827976,-0.000290997095865352,-0.000297863184859936,-0.000296591124317143,-0.000295836250800890,-0.000288959475638224,-0.000281536631309325,-0.000268977600030654,-0.000255594418813250,-0.000237788954240409,-0.000219166214894358,-0.000196776421788013,-0.000173755758239953,-0.000147618507825824,-0.000121170189044627,-9.21785596300005e-05,-6.31957913634798e-05,-3.21909522373386e-05,-1.48897874568125e-06,3.08113850095087e-05,6.26088214163090e-05,9.57910865964598e-05,0.000128498062176727,0.000162663115026186,0.000196697526863559,0.000232678507649252,0.000269383912357743,0.000309206016716929,0.000351405434691855,0.000398831953153266,0.000451459098838088,0.000512894128719519,0.000584122669198574,0.000669954245673063,0.000772880373942138,0.000899501427052986,0.00105465234274052,0.00124772169963748,0.00148709945292228,0.00178650854729232,0.00215974524025664,0.00262724642768595,0.00321121871353699,-0.00769647194304594])
    delay =  np.random.randint(0,16)
    h = lp32[delay::32]
    if np.linalg.norm(h)>0:
        h = h/np.linalg.norm(h)
    else:
        raise ValueError('Filter norm equals zero')
    y = np.convolve(x,h,'same')
    #print(y.size)
    #print(x.size)
    return y

def simulate_frequency_error(x):
    samp_rate = 1e6
    center_freq = 1e9
    er = 10e-6 
    freq_drift = center_freq*er
    t=np.arange(0,np.size(x)/samp_rate,1/samp_rate,dtype='float32')
    f = freq_drift*np.random.randn()
    cf = np.cos(2*np.pi*f*t) + 1j* np.sin(2*np.pi*f*t)
    y = x*cf
    return y

def simulate_realistic_channel(x,snr):
    y1 = simulate_timing_error(x)
    #print(sum(abs(y1)**2))
    #print([x.size,y1.size])
    
    y2 = simulate_frequency_error(y1)
    #print(sum(abs(y2)**2))
    #print([y1.size,y2.size])
    y3 = simulate_fading_channel(y2)
    #print(sum(abs(y3)**2))
    #print([y2.size,y3.size])
    y = add_noise(y3,snr)
    #print(sum(abs(y)**2))
    #print([y3.size,y.size])
    #print(y)
    return y